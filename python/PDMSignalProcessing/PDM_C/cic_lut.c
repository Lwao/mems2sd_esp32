// gcc main.c -o main.exe && main.exe

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <math.h>
#include <time.h>

#define PATH "C:/Users/levyg/Documents/MEGA/Repositories/mems2sd_esp32/python/PDMSignalProcessing/PDM_C/"
#define SAMPLES 1024
#define BYTE_PER_SAMPLE 4
// #define APPLY_MASK(x,i,b) (long)((((x>>(b-1-i))&0x00000001) << 1)-1)
#define APPLY_MASK(x,i) (long)((((x>>(31-i))&0x00000001) << 1)-1)
// #define APPLY_MASK(x,i) ((x>>(31-i))&0x00000001)
#define QUEUE_SIZE 2

#define MAX_OVERFLOW  1073741823 // (long)(pow(2,30)-1)
#define MIN_OVERFLOW -1073741824 // (long)(-pow(2,30))

#define BYTE_MASK_LEFT(i) (0xFF<<((3-i)*8))
#define SHIFT_BYTE_RIGHT(x, i) (x>>((3-i)*8))
#define LONG_CASTING(x) ((long)(x))
#define CHAR_MASK(x, i) (unsigned char)SHIFT_BYTE_RIGHT((LONG_CASTING(x) & BYTE_MASK_LEFT(i)), i)

#define LUT_DEPTH 256
#define LUT_WIDTH 8
#define INPUT_SAMPLE_SIZE 32

typedef short sample_t;

typedef struct 
{
    long acc_s1;
    long acc_s2;
    long prev_s1;
    long prev_s2;
} app_cic_t;

typedef struct 
{
    char (*ptr1)[LUT_WIDTH];
    char (*ptr2)[LUT_WIDTH];
    char (*ptr3)[LUT_WIDTH];
    char (*ptr4)[LUT_WIDTH];
} lut_ptrs_t;

void init_app_cic(app_cic_t *cic);
long swap_bytes_of_word(long x);

char INTEG_LUT[LUT_DEPTH][LUT_WIDTH] = {
    {-1, -2, -3, -4, -5, -6, -7, -8},
    {-1, -2, -3, -4, -5, -6, -7, -6},
    {-1, -2, -3, -4, -5, -6, -5, -6},
    {-1, -2, -3, -4, -5, -6, -5, -4},
    {-1, -2, -3, -4, -5, -4, -5, -6},
    {-1, -2, -3, -4, -5, -4, -5, -4},
    {-1, -2, -3, -4, -5, -4, -3, -4},
    {-1, -2, -3, -4, -5, -4, -3, -2},
    {-1, -2, -3, -4, -3, -4, -5, -6},
    {-1, -2, -3, -4, -3, -4, -5, -4},
    {-1, -2, -3, -4, -3, -4, -3, -4},
    {-1, -2, -3, -4, -3, -4, -3, -2},
    {-1, -2, -3, -4, -3, -2, -3, -4},
    {-1, -2, -3, -4, -3, -2, -3, -2},
    {-1, -2, -3, -4, -3, -2, -1, -2},
    {-1, -2, -3, -4, -3, -2, -1, 0},
    {-1, -2, -3, -2, -3, -4, -5, -6},
    {-1, -2, -3, -2, -3, -4, -5, -4},
    {-1, -2, -3, -2, -3, -4, -3, -4},
    {-1, -2, -3, -2, -3, -4, -3, -2},
    {-1, -2, -3, -2, -3, -2, -3, -4},
    {-1, -2, -3, -2, -3, -2, -3, -2},
    {-1, -2, -3, -2, -3, -2, -1, -2},
    {-1, -2, -3, -2, -3, -2, -1, 0},
    {-1, -2, -3, -2, -1, -2, -3, -4},
    {-1, -2, -3, -2, -1, -2, -3, -2},
    {-1, -2, -3, -2, -1, -2, -1, -2},
    {-1, -2, -3, -2, -1, -2, -1, 0},
    {-1, -2, -3, -2, -1, 0, -1, -2},
    {-1, -2, -3, -2, -1, 0, -1, 0},
    {-1, -2, -3, -2, -1, 0, 1, 0},
    {-1, -2, -3, -2, -1, 0, 1, 2},
    {-1, -2, -1, -2, -3, -4, -5, -6},
    {-1, -2, -1, -2, -3, -4, -5, -4},
    {-1, -2, -1, -2, -3, -4, -3, -4},
    {-1, -2, -1, -2, -3, -4, -3, -2},
    {-1, -2, -1, -2, -3, -2, -3, -4},
    {-1, -2, -1, -2, -3, -2, -3, -2},
    {-1, -2, -1, -2, -3, -2, -1, -2},
    {-1, -2, -1, -2, -3, -2, -1, 0},
    {-1, -2, -1, -2, -1, -2, -3, -4},
    {-1, -2, -1, -2, -1, -2, -3, -2},
    {-1, -2, -1, -2, -1, -2, -1, -2},
    {-1, -2, -1, -2, -1, -2, -1, 0},
    {-1, -2, -1, -2, -1, 0, -1, -2},
    {-1, -2, -1, -2, -1, 0, -1, 0},
    {-1, -2, -1, -2, -1, 0, 1, 0},
    {-1, -2, -1, -2, -1, 0, 1, 2},
    {-1, -2, -1, 0, -1, -2, -3, -4},
    {-1, -2, -1, 0, -1, -2, -3, -2},
    {-1, -2, -1, 0, -1, -2, -1, -2},
    {-1, -2, -1, 0, -1, -2, -1, 0},
    {-1, -2, -1, 0, -1, 0, -1, -2},
    {-1, -2, -1, 0, -1, 0, -1, 0},
    {-1, -2, -1, 0, -1, 0, 1, 0},
    {-1, -2, -1, 0, -1, 0, 1, 2},
    {-1, -2, -1, 0, 1, 0, -1, -2},
    {-1, -2, -1, 0, 1, 0, -1, 0},
    {-1, -2, -1, 0, 1, 0, 1, 0},
    {-1, -2, -1, 0, 1, 0, 1, 2},
    {-1, -2, -1, 0, 1, 2, 1, 0},
    {-1, -2, -1, 0, 1, 2, 1, 2},
    {-1, -2, -1, 0, 1, 2, 3, 2},
    {-1, -2, -1, 0, 1, 2, 3, 4},
    {-1, 0, -1, -2, -3, -4, -5, -6},
    {-1, 0, -1, -2, -3, -4, -5, -4},
    {-1, 0, -1, -2, -3, -4, -3, -4},
    {-1, 0, -1, -2, -3, -4, -3, -2},
    {-1, 0, -1, -2, -3, -2, -3, -4},
    {-1, 0, -1, -2, -3, -2, -3, -2},
    {-1, 0, -1, -2, -3, -2, -1, -2},
    {-1, 0, -1, -2, -3, -2, -1, 0},
    {-1, 0, -1, -2, -1, -2, -3, -4},
    {-1, 0, -1, -2, -1, -2, -3, -2},
    {-1, 0, -1, -2, -1, -2, -1, -2},
    {-1, 0, -1, -2, -1, -2, -1, 0},
    {-1, 0, -1, -2, -1, 0, -1, -2},
    {-1, 0, -1, -2, -1, 0, -1, 0},
    {-1, 0, -1, -2, -1, 0, 1, 0},
    {-1, 0, -1, -2, -1, 0, 1, 2},
    {-1, 0, -1, 0, -1, -2, -3, -4},
    {-1, 0, -1, 0, -1, -2, -3, -2},
    {-1, 0, -1, 0, -1, -2, -1, -2},
    {-1, 0, -1, 0, -1, -2, -1, 0},
    {-1, 0, -1, 0, -1, 0, -1, -2},
    {-1, 0, -1, 0, -1, 0, -1, 0},
    {-1, 0, -1, 0, -1, 0, 1, 0},
    {-1, 0, -1, 0, -1, 0, 1, 2},
    {-1, 0, -1, 0, 1, 0, -1, -2},
    {-1, 0, -1, 0, 1, 0, -1, 0},
    {-1, 0, -1, 0, 1, 0, 1, 0},
    {-1, 0, -1, 0, 1, 0, 1, 2},
    {-1, 0, -1, 0, 1, 2, 1, 0},
    {-1, 0, -1, 0, 1, 2, 1, 2},
    {-1, 0, -1, 0, 1, 2, 3, 2},
    {-1, 0, -1, 0, 1, 2, 3, 4},
    {-1, 0, 1, 0, -1, -2, -3, -4},
    {-1, 0, 1, 0, -1, -2, -3, -2},
    {-1, 0, 1, 0, -1, -2, -1, -2},
    {-1, 0, 1, 0, -1, -2, -1, 0},
    {-1, 0, 1, 0, -1, 0, -1, -2},
    {-1, 0, 1, 0, -1, 0, -1, 0},
    {-1, 0, 1, 0, -1, 0, 1, 0},
    {-1, 0, 1, 0, -1, 0, 1, 2},
    {-1, 0, 1, 0, 1, 0, -1, -2},
    {-1, 0, 1, 0, 1, 0, -1, 0},
    {-1, 0, 1, 0, 1, 0, 1, 0},
    {-1, 0, 1, 0, 1, 0, 1, 2},
    {-1, 0, 1, 0, 1, 2, 1, 0},
    {-1, 0, 1, 0, 1, 2, 1, 2},
    {-1, 0, 1, 0, 1, 2, 3, 2},
    {-1, 0, 1, 0, 1, 2, 3, 4},
    {-1, 0, 1, 2, 1, 0, -1, -2},
    {-1, 0, 1, 2, 1, 0, -1, 0},
    {-1, 0, 1, 2, 1, 0, 1, 0},
    {-1, 0, 1, 2, 1, 0, 1, 2},
    {-1, 0, 1, 2, 1, 2, 1, 0},
    {-1, 0, 1, 2, 1, 2, 1, 2},
    {-1, 0, 1, 2, 1, 2, 3, 2},
    {-1, 0, 1, 2, 1, 2, 3, 4},
    {-1, 0, 1, 2, 3, 2, 1, 0},
    {-1, 0, 1, 2, 3, 2, 1, 2},
    {-1, 0, 1, 2, 3, 2, 3, 2},
    {-1, 0, 1, 2, 3, 2, 3, 4},
    {-1, 0, 1, 2, 3, 4, 3, 2},
    {-1, 0, 1, 2, 3, 4, 3, 4},
    {-1, 0, 1, 2, 3, 4, 5, 4},
    {-1, 0, 1, 2, 3, 4, 5, 6},
    {1, 0, -1, -2, -3, -4, -5, -6},
    {1, 0, -1, -2, -3, -4, -5, -4},
    {1, 0, -1, -2, -3, -4, -3, -4},
    {1, 0, -1, -2, -3, -4, -3, -2},
    {1, 0, -1, -2, -3, -2, -3, -4},
    {1, 0, -1, -2, -3, -2, -3, -2},
    {1, 0, -1, -2, -3, -2, -1, -2},
    {1, 0, -1, -2, -3, -2, -1, 0},
    {1, 0, -1, -2, -1, -2, -3, -4},
    {1, 0, -1, -2, -1, -2, -3, -2},
    {1, 0, -1, -2, -1, -2, -1, -2},
    {1, 0, -1, -2, -1, -2, -1, 0},
    {1, 0, -1, -2, -1, 0, -1, -2},
    {1, 0, -1, -2, -1, 0, -1, 0},
    {1, 0, -1, -2, -1, 0, 1, 0},
    {1, 0, -1, -2, -1, 0, 1, 2},
    {1, 0, -1, 0, -1, -2, -3, -4},
    {1, 0, -1, 0, -1, -2, -3, -2},
    {1, 0, -1, 0, -1, -2, -1, -2},
    {1, 0, -1, 0, -1, -2, -1, 0},
    {1, 0, -1, 0, -1, 0, -1, -2},
    {1, 0, -1, 0, -1, 0, -1, 0},
    {1, 0, -1, 0, -1, 0, 1, 0},
    {1, 0, -1, 0, -1, 0, 1, 2},
    {1, 0, -1, 0, 1, 0, -1, -2},
    {1, 0, -1, 0, 1, 0, -1, 0},
    {1, 0, -1, 0, 1, 0, 1, 0},
    {1, 0, -1, 0, 1, 0, 1, 2},
    {1, 0, -1, 0, 1, 2, 1, 0},
    {1, 0, -1, 0, 1, 2, 1, 2},
    {1, 0, -1, 0, 1, 2, 3, 2},
    {1, 0, -1, 0, 1, 2, 3, 4},
    {1, 0, 1, 0, -1, -2, -3, -4},
    {1, 0, 1, 0, -1, -2, -3, -2},
    {1, 0, 1, 0, -1, -2, -1, -2},
    {1, 0, 1, 0, -1, -2, -1, 0},
    {1, 0, 1, 0, -1, 0, -1, -2},
    {1, 0, 1, 0, -1, 0, -1, 0},
    {1, 0, 1, 0, -1, 0, 1, 0},
    {1, 0, 1, 0, -1, 0, 1, 2},
    {1, 0, 1, 0, 1, 0, -1, -2},
    {1, 0, 1, 0, 1, 0, -1, 0},
    {1, 0, 1, 0, 1, 0, 1, 0},
    {1, 0, 1, 0, 1, 0, 1, 2},
    {1, 0, 1, 0, 1, 2, 1, 0},
    {1, 0, 1, 0, 1, 2, 1, 2},
    {1, 0, 1, 0, 1, 2, 3, 2},
    {1, 0, 1, 0, 1, 2, 3, 4},
    {1, 0, 1, 2, 1, 0, -1, -2},
    {1, 0, 1, 2, 1, 0, -1, 0},
    {1, 0, 1, 2, 1, 0, 1, 0},
    {1, 0, 1, 2, 1, 0, 1, 2},
    {1, 0, 1, 2, 1, 2, 1, 0},
    {1, 0, 1, 2, 1, 2, 1, 2},
    {1, 0, 1, 2, 1, 2, 3, 2},
    {1, 0, 1, 2, 1, 2, 3, 4},
    {1, 0, 1, 2, 3, 2, 1, 0},
    {1, 0, 1, 2, 3, 2, 1, 2},
    {1, 0, 1, 2, 3, 2, 3, 2},
    {1, 0, 1, 2, 3, 2, 3, 4},
    {1, 0, 1, 2, 3, 4, 3, 2},
    {1, 0, 1, 2, 3, 4, 3, 4},
    {1, 0, 1, 2, 3, 4, 5, 4},
    {1, 0, 1, 2, 3, 4, 5, 6},
    {1, 2, 1, 0, -1, -2, -3, -4},
    {1, 2, 1, 0, -1, -2, -3, -2},
    {1, 2, 1, 0, -1, -2, -1, -2},
    {1, 2, 1, 0, -1, -2, -1, 0},
    {1, 2, 1, 0, -1, 0, -1, -2},
    {1, 2, 1, 0, -1, 0, -1, 0},
    {1, 2, 1, 0, -1, 0, 1, 0},
    {1, 2, 1, 0, -1, 0, 1, 2},
    {1, 2, 1, 0, 1, 0, -1, -2},
    {1, 2, 1, 0, 1, 0, -1, 0},
    {1, 2, 1, 0, 1, 0, 1, 0},
    {1, 2, 1, 0, 1, 0, 1, 2},
    {1, 2, 1, 0, 1, 2, 1, 0},
    {1, 2, 1, 0, 1, 2, 1, 2},
    {1, 2, 1, 0, 1, 2, 3, 2},
    {1, 2, 1, 0, 1, 2, 3, 4},
    {1, 2, 1, 2, 1, 0, -1, -2},
    {1, 2, 1, 2, 1, 0, -1, 0},
    {1, 2, 1, 2, 1, 0, 1, 0},
    {1, 2, 1, 2, 1, 0, 1, 2},
    {1, 2, 1, 2, 1, 2, 1, 0},
    {1, 2, 1, 2, 1, 2, 1, 2},
    {1, 2, 1, 2, 1, 2, 3, 2},
    {1, 2, 1, 2, 1, 2, 3, 4},
    {1, 2, 1, 2, 3, 2, 1, 0},
    {1, 2, 1, 2, 3, 2, 1, 2},
    {1, 2, 1, 2, 3, 2, 3, 2},
    {1, 2, 1, 2, 3, 2, 3, 4},
    {1, 2, 1, 2, 3, 4, 3, 2},
    {1, 2, 1, 2, 3, 4, 3, 4},
    {1, 2, 1, 2, 3, 4, 5, 4},
    {1, 2, 1, 2, 3, 4, 5, 6},
    {1, 2, 3, 2, 1, 0, -1, -2},
    {1, 2, 3, 2, 1, 0, -1, 0},
    {1, 2, 3, 2, 1, 0, 1, 0},
    {1, 2, 3, 2, 1, 0, 1, 2},
    {1, 2, 3, 2, 1, 2, 1, 0},
    {1, 2, 3, 2, 1, 2, 1, 2},
    {1, 2, 3, 2, 1, 2, 3, 2},
    {1, 2, 3, 2, 1, 2, 3, 4},
    {1, 2, 3, 2, 3, 2, 1, 0},
    {1, 2, 3, 2, 3, 2, 1, 2},
    {1, 2, 3, 2, 3, 2, 3, 2},
    {1, 2, 3, 2, 3, 2, 3, 4},
    {1, 2, 3, 2, 3, 4, 3, 2},
    {1, 2, 3, 2, 3, 4, 3, 4},
    {1, 2, 3, 2, 3, 4, 5, 4},
    {1, 2, 3, 2, 3, 4, 5, 6},
    {1, 2, 3, 4, 3, 2, 1, 0},
    {1, 2, 3, 4, 3, 2, 1, 2},
    {1, 2, 3, 4, 3, 2, 3, 2},
    {1, 2, 3, 4, 3, 2, 3, 4},
    {1, 2, 3, 4, 3, 4, 3, 2},
    {1, 2, 3, 4, 3, 4, 3, 4},
    {1, 2, 3, 4, 3, 4, 5, 4},
    {1, 2, 3, 4, 3, 4, 5, 6},
    {1, 2, 3, 4, 5, 4, 3, 2},
    {1, 2, 3, 4, 5, 4, 3, 4},
    {1, 2, 3, 4, 5, 4, 5, 4},
    {1, 2, 3, 4, 5, 4, 5, 6},
    {1, 2, 3, 4, 5, 6, 5, 4},
    {1, 2, 3, 4, 5, 6, 5, 6},
    {1, 2, 3, 4, 5, 6, 7, 6},
    {1, 2, 3, 4, 5, 6, 7, 8},
};

long buffer[SAMPLES];

long integ_out[INPUT_SAMPLE_SIZE*SAMPLES] = {0};

/* 
0xD5591E4E4EC5597C
python: 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 2, 1, 0, -1, 0, 1, 2, 3, 2, 1, 2, 1, 0, 1, 2, 3, 2, 1, 2, 1, 0, 1, 2, 3, 2, 3, 4, 3, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 2, 1, 2, 3, 4, 5, 6, 5, 4, 
c     : 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 2, 1, 0, -1, 0, 1, 2, 3, 2, 1, 2, 1, 0, 1, 2, 3, 2, 1, 2, 1, 0, 1, 2, 3, 2, 3, 4, 3, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 2, 1, 2, 3, 4, 5, 6, 5, 4,
*/
int main()
{
    app_cic_t cic;
    lut_ptrs_t *lut_vec;
    long acc0=0, acc1=0, acc2=0, acc3=0, acc4=0;
    long sample;// = 0xd5591e4e;
    unsigned long samples[2] = {0xD5591E4E, 0x4EC5597C};
    size_t num_samples;

    lut_vec = (lut_ptrs_t*) malloc(sizeof(lut_ptrs_t));

    init_app_cic(&cic);
    
    FILE *fileb, *filetxt;

    fileb = fopen(PATH "clipped_data_bin", "r");
    // filetxt = fopen(PATH "c_cic_processed", "w"); fprintf(filetxt, ""); fclose(filetxt);
    // filetxt = fopen(PATH "c_cic_processed", "a");
    filetxt = fopen(PATH "pcm_c", "w"); fprintf(filetxt, ""); fclose(filetxt);
    filetxt = fopen(PATH "pcm_c", "a");

    if(fileb)
    {   
        num_samples = fread(buffer, BYTE_PER_SAMPLE, SAMPLES, fileb);

        // num_samples = 2;
        if(num_samples>0)
        // while(fread(buffer, BYTE_PER_SAMPLE, SAMPLES, fileb) == SAMPLES)
        {
            // for(int ii=0; ii<num_samples; ii++) buffer[ii] = swap_bytes_of_word(buffer[ii]);
            // firmware processing: start
            clock_t begin=clock();
            for(int kk=0; kk<1000; kk++){
            for(int ii=0; ii<num_samples; ii++)
            {
                sample = buffer[ii];

                integ_out[INPUT_SAMPLE_SIZE*ii] = (cic.acc_s1+APPLY_MASK(sample,(0)%INPUT_SAMPLE_SIZE));
                for(int jj=INPUT_SAMPLE_SIZE*ii+1; jj<INPUT_SAMPLE_SIZE*(ii+1); jj++) integ_out[jj] = integ_out[jj-1] + APPLY_MASK(sample,jj%INPUT_SAMPLE_SIZE);

                // // cumulative sum for first integrator stage
                // lut_vec->ptr1 = &INTEG_LUT[CHAR_MASK(sample,0)];
                // lut_vec->ptr2 = &INTEG_LUT[CHAR_MASK(sample,1)];
                // lut_vec->ptr3 = &INTEG_LUT[CHAR_MASK(sample,2)];
                // lut_vec->ptr4 = &INTEG_LUT[CHAR_MASK(sample,3)];

                // // accumulation between arrays of LUT
                // acc0 = (long) cic.acc_s1;
                // acc1 = (long) (*lut_vec->ptr1)[LUT_WIDTH-1]+acc0;
                // acc2 = (long) (*lut_vec->ptr2)[LUT_WIDTH-1]+acc1;
                // acc3 = (long) (*lut_vec->ptr3)[LUT_WIDTH-1]+acc2;

                // // distribute integrator output in proper buffer
                // for(int jj=0; jj<LUT_WIDTH; jj++)
                // {
                //     integ_out[0  + jj + INPUT_SAMPLE_SIZE*ii] = (long) (*lut_vec->ptr1)[jj]+acc0;
                //     integ_out[8  + jj + INPUT_SAMPLE_SIZE*ii] = (long) (*lut_vec->ptr2)[jj]+acc1;
                //     integ_out[16 + jj + INPUT_SAMPLE_SIZE*ii] = (long) (*lut_vec->ptr3)[jj]+acc2;
                //     integ_out[24 + jj + INPUT_SAMPLE_SIZE*ii] = (long) (*lut_vec->ptr4)[jj]+acc3;
                // }

                cic.acc_s1 = integ_out[INPUT_SAMPLE_SIZE*(ii+1)-1];
                
                integ_out[INPUT_SAMPLE_SIZE*ii] += cic.acc_s2;
                for(int jj=INPUT_SAMPLE_SIZE*ii+1; jj<INPUT_SAMPLE_SIZE*(ii+1); jj++) integ_out[jj] += integ_out[jj-1];

                cic.acc_s2 = integ_out[INPUT_SAMPLE_SIZE*(ii+1)-1];
            }
            }
            // firmware processing: end

            clock_t end=clock();
            printf("Time taken:%lf",1e3*(double)(end-begin)/CLOCKS_PER_SEC);
            for(int ii=0; ii<INPUT_SAMPLE_SIZE*num_samples; ii++) fprintf(filetxt, "%d\n", integ_out[ii]);
            // for(int ii=0; ii<INPUT_SAMPLE_SIZE*num_samples; ii++) printf("%d, ", integ_out[ii]);
        }

    } else {printf("File not read.\n");}
    fclose(fileb);
    fclose(filetxt);
    
    return 0;
}

long swap_bytes_of_word(long x)
{
    return ((x & 0x000000FF) << 24) | ((x & 0xFF000000) >> 24) | ((x & 0x0000FF00) << 8) | ((x & 0x00FF0000) >> 8);
}

void init_app_cic(app_cic_t *cic)
{
    cic->acc_s1 = 0;
    cic->acc_s2 = 0;
    cic->prev_s1 = 0;
    cic->prev_s2 = 0;
}
